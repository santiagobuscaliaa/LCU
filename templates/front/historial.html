{% extends "a.html" %}

{% block title %}Historial de Compras - Cine LCU{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/front/historial.css') }}">

{% endblock %}

{% block content %}
<main>
    <div class="page">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h3 class="sidebar-title">MI CUENTA</h3>
            <nav class="menu">
                <a href="{{ url_for('usuario') }}" class="menu-item">Editar usuario</a>
                <a href="{{ url_for('historial') }}" class="menu-item activo">Historial de compras</a>
                <a href="{{ url_for('logout') }}" class="menu-item cerrar">Cerrar sesión</a>
            </nav>
        </aside>

        <!-- Contenido principal -->
        <main class="content">
            <!-- ✨ MENSAJES FLASH ✨ -->
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                {% for category, message in messages %}
                  <div class="flash {{ category }}">{{ message }}</div>
                {% endfor %}
              {% endif %}
            {% endwith %}
            
            <h1 class="content-title">Historial de compras</h1>
            
            {% if param.historial %}
            <table class="tabla-historial">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Película</th>
                        <th>Día</th>
                        <th>Horario</th>
                        <th>Candy</th>
                        <th>Total</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    {# ✅ CORREGIDO: Usar namespace para poder modificar la variable en el loop #}
                    {% set ns = namespace(total=0) %}
                    {% for compra in param.historial %}
                    <tr>
                        <td>{{ compra.id }}</td>
                        <td>{{ compra.titulo or '-' }}</td>
                        <td>{{ compra.dia or '-' }}</td>
                        <td>{{ compra.horario or '-' }}</td>
                        <td>{{ compra.candy or 'Sin candy' }}</td>
                        <td>${{ compra.total }}</td>
                        <td>
                            {% if compra.pagado == 1 %}
                                <span style="color: green;">✓ Pagado</span>
                            {% else %}
                                <span style="color: red;">✗ Pendiente</span>
                            {% endif %}
                        </td>
                    </tr>
                    {# ✅ Sumar correctamente convirtiendo a int #}
                    {% set ns.total = ns.total + (compra.total | int) %}
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="5">TOTAL GASTADO</th>
                        <th colspan="2">${{ ns.total }}</th>
                    </tr>
                </tfoot>
            </table>
            {% else %}
            <p>No tienes compras registradas aún.</p>
            <a href="{{ url_for('cartelera') }}" class="boton">Ver cartelera</a>
            {% endif %}
        </main>
    </div>
</main>
{% endblock %}